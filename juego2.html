<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¡Sal en la foto! Desafío Naranja</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #ffde00; 
            background-image: radial-gradient(#facc15 15%, transparent 16%), radial-gradient(#facc15 15%, transparent 16%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            font-family: 'Comic Neue', cursive;
            cursor: none;
            user-select: none;
            touch-action: none; 
        }

        #stage {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #viewfinder {
            position: fixed;
            --vf-width: 360px;
            --vf-height: 260px;
            width: var(--vf-width);
            height: var(--vf-height);
            border: 6px solid #000;
            box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.6), 10px 10px 0px rgba(0,0,0,0.2);
            border-radius: 12px;
            pointer-events: none;
            z-index: 100;
            top: 50%; 
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.05);
            transition: border-color 0.2s, transform 0.1s ease-out;
        }

        @media (max-width: 640px) {
            #viewfinder {
                --vf-width: 220px;
                --vf-height: 160px;
                border-width: 4px;
            }
            #comic-feedback {
                font-size: 50px !important;
                padding: 10px 30px !important;
            }
            #photo-result {
                width: 260px !important;
            }
        }

        #viewfinder.perfect {
            border-color: #fbbf24;
            border-width: 8px;
        }

        #flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 5px solid #000;
        }
        .top-left { top: -5px; left: -5px; border-right: 0; border-bottom: 0; }
        .top-right { top: -5px; right: -5px; border-left: 0; border-bottom: 0; }
        .bottom-left { bottom: -5px; left: -5px; border-right: 0; border-top: 0; }
        .bottom-right { bottom: -5px; right: -5px; border-left: 0; border-top: 0; }

        .person {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 140px;
            will-change: transform;
            filter: drop-shadow(5px 5px 0px rgba(0,0,0,0.3));
        }

        .speech-bubble {
            position: absolute;
            top: -40px;
            background: white;
            border: 3px solid black;
            border-radius: 20px;
            padding: 5px 12px;
            font-family: 'Bangers', cursive;
            font-size: 18px;
            white-space: nowrap;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .speech-bubble.active {
            opacity: 1;
            transform: scale(1) translateY(-10px);
        }

        #comic-feedback {
            position: fixed;
            top: 25%; 
            left: 50%;
            transform: translate(-50%, -50%) scale(0) rotate(-10deg);
            font-family: 'Bangers', cursive;
            font-size: 80px;
            color: #fff;
            text-shadow: 8px 8px 0px #000;
            z-index: 500;
            pointer-events: none;
            background: #ef4444;
            padding: 20px 60px;
            border: 8px solid #000;
            transition: transform 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045), opacity 0.2s;
            opacity: 0;
            display: none; /* Inicialmente oculto */
        }

        /* Mission UI */
        #mission-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) rotate(-1deg);
            background: white;
            border: 4px solid black;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 6px 6px 0px black;
            z-index: 200;
        }

        #mission-target-preview {
            width: 40px;
            height: 40px;
            border: 3px solid black;
            border-radius: 50%;
        }

        .mission-text {
            font-family: 'Bangers', cursive;
            font-size: 24px;
            color: black;
        }

        #start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .btn-start {
            background: #f97316;
            border: 4px solid white;
            padding: 15px 40px;
            font-family: 'Bangers', cursive;
            font-size: 32px;
            margin-top: 30px;
            cursor: pointer;
            box-shadow: 0 8px 0 #9a3412;
        }

        .btn-start:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #9a3412;
        }

        /* Foto Result UI - Polaroid */
        #photo-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0) rotate(-5deg);
            width: 360px;
            background: #fff;
            padding: 15px 15px 70px 15px;
            border: 1px solid #ddd;
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
            z-index: 1500;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #photo-result.show {
            transform: translate(-50%, -50%) scale(1.1) rotate(2deg);
        }
        #photo-canvas-container {
            width: 100%;
            aspect-ratio: 360 / 260; 
            background: #f3f4f6;
            border: 3px solid #000;
            overflow: hidden;
            position: relative;
        }

        /* Botón de Salir */
        .btn-exit {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            font-family: 'Bangers', cursive;
            font-size: 24px;
            padding: 12px 35px;
            border: 4px solid #fff;
            box-shadow: 0px 6px 0px #ef4444;
            cursor: pointer !important;
            z-index: 1001;
            transition: all 0.1s;
            pointer-events: auto;
            border-radius: 8px;
        }

        .btn-exit:hover {
            background: #ef4444;
            box-shadow: 0px 6px 0px #000;
        }

        .btn-exit:active {
            transform: translate(-50%, 4px);
            box-shadow: 0px 2px 0px #000;
        }

        .rec-indicator {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #ff0000;
            color: white;
            padding: 2px 8px;
            font-family: 'Bangers', cursive;
            border: 2px solid black;
            font-size: 16px;
            animation: blink 0.8s infinite;
        }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-10deg); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(-2deg); opacity: 1; }
        }
    </style>
</head>
<body onclick="takePhoto()" ontouchstart="handleTouch(event)" ontouchmove="handleTouch(event)">

    <div id="start-overlay">
        <h1 style="font-family: 'Bangers', cursive; font-size: 60px;">¡PREPÁRATE!</h1>
        <p style="font-size: 24px;">Debes encontrar a este personaje entre la multitud:</p>
        <div id="overlay-target-circle" style="width: 100px; height: 100px; border: 6px solid white; border-radius: 50%; margin-top: 20px;"></div>
        <button class="btn-start" onclick="startGame(event)">¡A POR ELLOS!</button>
    </div>

    <!-- Polaroid Result -->
    <div id="photo-result">
        <div id="photo-canvas-container"></div>
        <div style="text-align: center; margin-top: 20px; font-family: 'Bangers', cursive; font-size: 28px; color: #333; letter-spacing: 1px;">¡FOTAZA!</div>
    </div>

    <div id="flash"></div>
    <div id="comic-feedback">¡PERFECTO!</div>
    
    <div id="mission-panel" style="display: none;">
        <span class="mission-text">OBJETIVO:</span>
        <div id="mission-target-preview"></div>
        <span class="mission-text" id="mission-color-name">???</span>
    </div>
    
    <button class="btn-exit" onclick="event.stopPropagation(); window.location.href='index.html'">SALIR DEL JUEGO</button>

    <div id="viewfinder">
        <div class="rec-indicator">CLICK!</div>
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
    </div>

    <div id="stage"></div>

    <script>
        const stage = document.getElementById('stage');
        const viewfinder = document.getElementById('viewfinder');
        const flash = document.getElementById('flash');
        const feedback = document.getElementById('comic-feedback');
        const missionPanel = document.getElementById('mission-panel');
        const overlay = document.getElementById('start-overlay');
        const photoResult = document.getElementById('photo-result');
        const photoCanvasContainer = document.getElementById('photo-canvas-container');
        
        const personCount = 8;
        const people = [];
        
        const funPhrases = [
            "¡PATATA!", "¡CHEESE!", "¡MAMMA MIA!", "¡LOOK AT ME!",
            "¡CIAO BELLO!", "¡SAY WHISKY!", "¡SALGO GUAPO?", "¡QUITA BICHO!",
            "¡SMILE!", "¡POLLITO!", "¡PIZZA!", "¡OH MY GOD!",
            "¡AQUÍ!", "¡YEE-HAW!", "¡BELLA!", "¡DO I LOOK GOOD?",
            "¡PHOTO BOMB!", "¡ESPAGUETI!", "¡HOLA CARACOLA!", "¡WHATCHA DOING?",
            "¡VAMOS!", "¡ESA MANO!", "¡ME MEO!", "¡EEEOO?",
            "¡VIVA LOS NOVIOS!", "¡QUE NO SALGO!", "¡NO VEO!", "¡ESA BODA!"
        ];

        function shuffle(array) {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        }

        const characterData = [
            { color: '#ef4444', name: 'ROJO' },
            { color: '#3b82f6', name: 'AZUL' },
            { color: '#10b981', name: 'VERDE' },
            { color: '#f97316', name: 'NARANJA' }, 
            { color: '#8b5cf6', name: 'MORADO' },
            { color: '#ec4899', name: 'ROSA' },
            { color: '#06b6d4', name: 'CIAN' },
            { color: '#000000', name: 'NEGRO' }
        ];

        let targetPerson = null;
        let mouseX = window.innerWidth / 2;
        let lastMouseMoveTime = Date.now();
        let isMouseIdle = false;
        let feedbackTimer = null;
        let gameActive = false;

        function startGame(e) {
            if(e) e.stopPropagation();
            overlay.style.display = 'none';
            photoResult.classList.remove('show');
            missionPanel.style.display = 'flex';
            gameActive = true;
        }

        function setupMission() {
            const targetData = characterData[Math.floor(Math.random() * characterData.length)];
            targetPerson = targetData;
            document.getElementById('overlay-target-circle').style.backgroundColor = targetData.color;
            document.getElementById('mission-target-preview').style.backgroundColor = targetData.color;
            document.getElementById('mission-color-name').innerText = targetData.name;
        }

        function createPerson(index, data) {
            const container = document.createElement('div');
            container.className = 'person';
            const startX = (window.innerWidth / (personCount + 1)) * (index + 1);
            const scale = 0.7 + Math.random() * 0.6;
            
            const personState = {
                id: index,
                el: container,
                currentX: startX,
                currentY: 0,
                velX: 0,
                angle: 0,
                phase: Math.random() * Math.PI * 2,
                personality: 0.02 + Math.random() * 0.1,
                isPosing: false,
                phraseTimer: Math.random() * 200,
                color: data.color,
                scale: scale,
                phrasePool: shuffle(funPhrases),
                phraseIndex: 0
            };

            const svgMarkup = `
                <div class="speech-bubble" id="bubble-${index}">${personState.phrasePool[0]}</div>
                <div class="character-svg-wrapper" style="transform: scale(${scale}); transform-origin: bottom center;">
                    <svg width="120" height="200" viewBox="0 0 120 200" style="overflow: visible;">
                        <rect x="42" y="160" width="12" height="40" fill="#000" />
                        <rect x="66" y="160" width="12" height="40" fill="#000" />
                        <path d="M12 170 Q12 60 60 60 Q108 60 108 170" fill="#000" />
                        <path d="M18 165 Q18 70 60 70 Q102 70 102 165" fill="${data.color}" />
                        <circle cx="60" cy="45" r="38" fill="#000" />
                        <circle cx="60" cy="45" r="34" fill="#ffdbac" />
                        <circle cx="45" cy="40" r="10" fill="#000" />
                        <circle cx="45" cy="40" r="8" fill="#fff" />
                        <circle id="p-l-${index}" cx="45" cy="40" r="4" fill="#000" />
                        <circle cx="75" cy="40" r="12" fill="#000" />
                        <circle cx="75" cy="40" r="10" fill="#fff" />
                        <circle id="p-r-${index}" cx="75" cy="40" r="5" fill="#000" />
                        <path id="m-${index}" d="M45 65 Q60 65 75 65" stroke="black" stroke-width="4" stroke-linecap="round" fill="none" />
                    </svg>
                </div>
            `;
            
            container.innerHTML = svgMarkup;
            stage.appendChild(container);
            
            personState.pupilL = document.getElementById(`p-l-${index}`);
            personState.pupilR = document.getElementById(`p-r-${index}`);
            personState.mouth = document.getElementById(`m-${index}`);
            personState.bubble = document.getElementById(`bubble-${index}`);
            personState.svgWrapper = container.querySelector('.character-svg-wrapper');
            
            return personState;
        }

        setupMission();
        for (let i = 0; i < personCount; i++) {
            people.push(createPerson(i, characterData[i]));
        }

        function handleTouch(e) {
            if (e.touches && e.touches[0]) {
                updatePosition(e.touches[0].clientX);
            }
        }

        window.addEventListener('mousemove', (e) => {
            updatePosition(e.clientX, e.movementX);
        });

        function updatePosition(x, movementX = 0) {
            mouseX = x;
            viewfinder.style.left = `${mouseX}px`;
            viewfinder.style.transform = `translate(-50%, -50%) rotate(${movementX * 0.2}deg)`;
            lastMouseMoveTime = Date.now();
            if (isMouseIdle) {
                isMouseIdle = false;
            }
        }

        function takePhoto() {
            if (!gameActive) return;

            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 100);

            const targetObj = people.find(p => p.color === targetPerson.color);
            const diff = Math.abs(targetObj.currentX - mouseX);
            const threshold = window.innerWidth < 640 ? 30 : 35;

            if (diff < threshold) {
                gameActive = false;
                showFeedback("¡FOTAZA!", "#22c55e", true);
                renderPhotoResult();
                
                setTimeout(() => {
                    photoResult.classList.add('show');
                }, 850);

                setTimeout(() => {
                    photoResult.classList.remove('show');
                    setupMission();
                    overlay.style.display = 'flex';
                }, 4500);
            } else {
                showFeedback("¡NO ES ESE!", "#ef4444", false);
            }
        }

        function renderPhotoResult() {
            photoCanvasContainer.innerHTML = '';
            const canvasW = photoCanvasContainer.offsetWidth;
            const viewfinderW = parseInt(getComputedStyle(viewfinder).getPropertyValue('--vf-width'));
            const scaleFactor = canvasW / viewfinderW; 
            
            people.forEach(p => {
                const clone = p.svgWrapper.cloneNode(true);
                clone.style.position = 'absolute';
                const relX = (p.currentX - mouseX) * scaleFactor + (canvasW / 2);
                clone.style.left = `${relX - 30}px`; 
                clone.style.bottom = `5px`;
                clone.style.transform = `scale(${p.scale * scaleFactor})`;
                photoCanvasContainer.appendChild(clone);
            });
        }

        function showFeedback(text, color, isFinal) {
            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
                feedback.style.display = 'none';
            }
            
            feedback.innerText = text;
            feedback.style.background = color;
            feedback.style.display = 'block';
            feedback.style.opacity = '1';
            feedback.style.animation = 'none';
            feedback.offsetHeight; 
            feedback.style.animation = 'pop 0.5s forwards';
            
            // Si es final, se oculta rápido para no solaparse con la Polaroid
            const duration = isFinal ? 600 : 1000;
            
            feedbackTimer = setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transform = 'translate(-50%, -50%) scale(0)';
                // Lo ocultamos completamente del DOM después de la transición
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 200);
            }, duration);
        }

        function update() {
            const now = Date.now();
            const isMobile = window.innerWidth < 640;
            const vfRect = viewfinder.getBoundingClientRect();
            const vCenterX = mouseX;
            const vCenterY = vfRect.top + vfRect.height / 2;
            const floorY = vfRect.bottom - (isMobile ? 10 : 20);

            const detectW = isMobile ? 85 : 150;
            const detectH = isMobile ? 75 : 120;
            const spacing = isMobile ? 50 : 70;

            if (now - lastMouseMoveTime > 800 && !isMouseIdle) {
                isMouseIdle = true;
            }

            if (targetPerson && gameActive) {
                const targetObj = people.find(p => p.color === targetPerson.color);
                if (Math.abs(targetObj.currentX - mouseX) < (isMobile ? 22 : 30)) {
                    viewfinder.classList.add('perfect');
                } else {
                    viewfinder.classList.remove('perfect');
                }
            }

            people.forEach((p, i) => {
                const headRect = p.el.getBoundingClientRect();
                const hcx = headRect.left + headRect.width / 2;
                const hcy = headRect.top + (isMobile ? 25 : 45); 
                p.isPosing = Math.abs(hcx - vCenterX) < detectW && Math.abs(hcy - vCenterY) < detectH;

                p.phraseTimer--;
                if (p.phraseTimer <= 0) {
                    if (p.phraseTimer === 0) {
                        p.phraseIndex = (p.phraseIndex + 1) % p.phrasePool.length;
                        p.bubble.innerText = p.phrasePool[p.phraseIndex];
                    }
                    p.bubble.classList.add('active');
                    if (p.phraseTimer < -60) p.phraseTimer = 200 + Math.random() * 300;
                } else {
                    p.bubble.classList.remove('active');
                }

                if (isMouseIdle || !gameActive) {
                    p.velX = 0;
                    p.currentY *= 0.2;
                    p.angle *= 0.2;
                    if (p.isPosing) p.mouth.setAttribute('d', 'M40 60 Q60 85 80 60'); 
                } else {
                    if (p.isPosing) {
                        let separationForce = 0;
                        const minDistance = isMobile ? 75 : 110;
                        people.forEach(other => {
                            if (other.id !== p.id && other.isPosing) {
                                const dist = p.currentX - other.currentX;
                                if (Math.abs(dist) < minDistance) {
                                    const force = (minDistance - Math.abs(dist)) * (p.personality * 2);
                                    separationForce += dist > 0 ? force : -force;
                                }
                            }
                        });
                        p.velX *= 0.6; 
                        p.velX += separationForce;
                        p.currentX += p.velX;
                        p.currentY *= 0.7;
                        p.angle *= 0.7;
                        p.mouth.setAttribute('d', 'M45 62 Q60 75 75 62');
                    } else {
                        const offsetFromMouse = (i - (personCount - 1) / 2) * spacing;
                        const targetX = mouseX + offsetFromMouse;
                        const dx = targetX - p.currentX;
                        p.velX = dx * p.personality;
                        p.currentX += p.velX;

                        const moveSpeed = Math.abs(p.velX);
                        if (moveSpeed > 0.2) {
                            p.currentY = -Math.abs(Math.sin(now * 0.02 + p.phase)) * (moveSpeed * 3);
                            p.angle = Math.sin(now * 0.2 + p.phase) * (moveSpeed * 1.2);
                            p.mouth.setAttribute('d', 'M50 65 Q60 70 70 65');
                        } else {
                            p.currentY *= 0.8;
                            p.angle *= 0.8;
                            p.mouth.setAttribute('d', 'M48 65 Q60 65 72 65');
                        }
                    }
                }

                p.currentX = Math.max(40, Math.min(window.innerWidth - 40, p.currentX));
                const visualCharacterHeight = isMobile ? 120 : 200; 
                const topPos = floorY - visualCharacterHeight + p.currentY;
                
                p.el.style.top = `${topPos}px`;
                p.el.style.transform = `translate(${p.currentX - (isMobile ? 42 : 60)}px, 0) rotate(${p.angle}deg)`;
                
                updateEyes(p, vCenterX, vCenterY, hcx, hcy);
            });

            requestAnimationFrame(update);
        }

        function updateEyes(p, vcx, vcy, hcx, hcy) {
            const angle = Math.atan2(vcy - hcy, vcx - hcx);
            const dist = Math.min(8, Math.hypot(vcy - hcy, vcx - hcx) / 40);
            const ox = Math.cos(angle) * dist;
            const oy = Math.sin(angle) * dist;
            p.pupilL.setAttribute('cx', 45 + ox);
            p.pupilL.setAttribute('cy', 40 + oy);
            p.pupilR.setAttribute('cx', 75 + ox);
            p.pupilR.setAttribute('cy', 40 + oy);
        }

        update();
    </script>
</body>
</html>